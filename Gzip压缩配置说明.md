# Gzip å‹ç¼©é…ç½®è¯´æ˜

## ğŸ“¦ å®‰è£…ä¾èµ–

é¦–å…ˆéœ€è¦å®‰è£… `vite-plugin-compression` æ’ä»¶ï¼š

```bash
pnpm add -D vite-plugin-compression
```

## âš™ï¸ é…ç½®è¯´æ˜

### 1. Vite é…ç½®ï¼ˆæ„å»ºæ—¶å‹ç¼©ï¼‰

åœ¨ `vite.config.ts` ä¸­å·²æ·»åŠ ä¸¤ä¸ªå‹ç¼©æ’ä»¶ï¼š

#### Gzip å‹ç¼©
- **ä½œç”¨**ï¼šæ„å»ºæ—¶ç”Ÿæˆ `.gz` æ–‡ä»¶
- **ä¼˜åŠ¿**ï¼šNginx å¯ä»¥ç›´æ¥ä½¿ç”¨é¢„å‹ç¼©æ–‡ä»¶ï¼Œæ€§èƒ½æ›´å¥½
- **å‹ç¼©ç®—æ³•**ï¼šgzip
- **å‹ç¼©é˜ˆå€¼**ï¼š10KBï¼ˆå°äºæ­¤å¤§å°çš„æ–‡ä»¶ä¸å‹ç¼©ï¼‰

#### Brotli å‹ç¼©ï¼ˆå¯é€‰ï¼‰
- **ä½œç”¨**ï¼šæ„å»ºæ—¶ç”Ÿæˆ `.br` æ–‡ä»¶
- **ä¼˜åŠ¿**ï¼šå‹ç¼©ç‡æ¯” gzip é«˜ 15-20%
- **æ³¨æ„**ï¼šéœ€è¦ Nginx æ”¯æŒ brotli æ¨¡å—

### 2. Nginx é…ç½®ï¼ˆè¿è¡Œæ—¶å‹ç¼©ï¼‰

#### ä¸»è¦é…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|---|------|
| `gzip on` | å¯ç”¨ | å¯ç”¨ gzip å‹ç¼© |
| `gzip_vary on` | å¯ç”¨ | æ·»åŠ  Vary: Accept-Encoding å“åº”å¤´ |
| `gzip_min_length` | 1024 | æœ€å°å‹ç¼©æ–‡ä»¶å¤§å°ï¼ˆ1KBï¼‰ |
| `gzip_comp_level` | 6 | å‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼Œ6 æ˜¯å¹³è¡¡ç‚¹ï¼‰ |
| `gzip_static on` | å¯ç”¨ | ä¼˜å…ˆä½¿ç”¨é¢„å‹ç¼©çš„ .gz æ–‡ä»¶ |

#### å‹ç¼©çº§åˆ«è¯´æ˜

- **1-3**ï¼šå‹ç¼©é€Ÿåº¦å¿«ï¼Œä½†å‹ç¼©ç‡ä½
- **4-6**ï¼šå¹³è¡¡å‹ç¼©ç‡å’Œé€Ÿåº¦ï¼ˆæ¨è 6ï¼‰
- **7-9**ï¼šå‹ç¼©ç‡é«˜ï¼Œä½† CPU æ¶ˆè€—å¤§

#### æ”¯æŒçš„ MIME ç±»å‹

å·²é…ç½®å‹ç¼©ä»¥ä¸‹ç±»å‹çš„æ–‡ä»¶ï¼š
- æ–‡æœ¬æ–‡ä»¶ï¼š`text/plain`, `text/css`, `text/xml`, `text/javascript`
- åº”ç”¨æ–‡ä»¶ï¼š`application/json`, `application/javascript`, `application/xml`
- å­—ä½“æ–‡ä»¶ï¼š`font/woff`, `font/woff2`, `font/ttf`
- SVGï¼š`image/svg+xml`

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. æ„å»ºé¡¹ç›®

```bash
pnpm run build
```

æ„å»ºå®Œæˆåï¼Œä¼šåœ¨ `dist` ç›®å½•ç”Ÿæˆï¼š
- åŸå§‹æ–‡ä»¶ï¼š`assets/js/index-xxx.js`
- Gzip æ–‡ä»¶ï¼š`assets/js/index-xxx.js.gz`
- Brotli æ–‡ä»¶ï¼š`assets/js/index-xxx.js.br`ï¼ˆå¦‚æœå¯ç”¨ï¼‰

### 2. éƒ¨ç½²åˆ° Nginx

å°†æ„å»ºåçš„ `dist` ç›®å½•å†…å®¹å¤åˆ¶åˆ° Nginx çš„ `/usr/share/nginx/html` ç›®å½•ã€‚

### 3. éªŒè¯å‹ç¼©

#### æ–¹æ³•ä¸€ï¼šæµè§ˆå™¨å¼€å‘è€…å·¥å…·

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. åˆ·æ–°é¡µé¢
4. æŸ¥çœ‹è¯·æ±‚çš„ Response Headersï¼š
   - åº”è¯¥çœ‹åˆ° `Content-Encoding: gzip`
   - æ–‡ä»¶å¤§å°åº”è¯¥æ˜æ˜¾å‡å°

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ curl

```bash
# æ£€æŸ¥æ˜¯å¦å¯ç”¨ gzip
curl -H "Accept-Encoding: gzip" -I http://47.103.169.121

# åº”è¯¥çœ‹åˆ°å“åº”å¤´åŒ…å«ï¼š
# Content-Encoding: gzip
```

#### æ–¹æ³•ä¸‰ï¼šåœ¨çº¿å·¥å…·

ä½¿ç”¨ [GTmetrix](https://gtmetrix.com/) æˆ– [PageSpeed Insights](https://pagespeed.web.dev/) æµ‹è¯•å‹ç¼©æ•ˆæœã€‚

## ğŸ“Š å‹ç¼©æ•ˆæœé¢„æœŸ

### å…¸å‹å‹ç¼©ç‡

| æ–‡ä»¶ç±»å‹ | åŸå§‹å¤§å° | Gzip å‹ç¼©å | å‹ç¼©ç‡ |
|---------|---------|------------|--------|
| JavaScript | 500KB | 150KB | 70% |
| CSS | 100KB | 25KB | 75% |
| HTML | 50KB | 15KB | 70% |
| JSON | 200KB | 50KB | 75% |

### æ€§èƒ½æå‡

- **ä¼ è¾“æ—¶é—´**ï¼šå‡å°‘ 60-80%
- **å¸¦å®½æ¶ˆè€—**ï¼šå‡å°‘ 60-80%
- **é¦–å±åŠ è½½**ï¼šæå‡ 30-50%

## ğŸ”§ é«˜çº§é…ç½®

### 1. ä»…åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨å‹ç¼©

```typescript
// vite.config.ts
plugins: [
  ...setupVitePlugins(viteEnv, buildTime),
  // ä»…åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨å‹ç¼©
  ...(configEnv.mode === 'prod' ? [
    viteCompression({
      // ... é…ç½®
    })
  ] : [])
]
```

### 2. è‡ªå®šä¹‰å‹ç¼©æ–‡ä»¶ç±»å‹

```typescript
viteCompression({
  filter: /\.(js|mjs|json|css|html|svg|woff|woff2)$/i, // è‡ªå®šä¹‰æ–‡ä»¶ç±»å‹
  threshold: 5120, // 5KB é˜ˆå€¼
})
```

### 3. åŒæ—¶ä¿ç•™åŸæ–‡ä»¶å’Œå‹ç¼©æ–‡ä»¶

```typescript
viteCompression({
  deleteOriginFile: false, // ä¿ç•™åŸæ–‡ä»¶ï¼ˆé»˜è®¤ï¼‰
})
```

### 4. Nginx Brotli æ”¯æŒï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ä½¿ç”¨ Brotli å‹ç¼©ï¼ˆå‹ç¼©ç‡æ›´é«˜ï¼‰ï¼Œéœ€è¦ï¼š

1. **å®‰è£… Nginx Brotli æ¨¡å—**ï¼š
   ```bash
   # Ubuntu/Debian
   apt-get install nginx-module-brotli
   
   # æˆ–ä½¿ç”¨ Docker é•œåƒï¼ˆå·²åŒ…å« brotliï¼‰
   # nginx:alpine æˆ– nginx:latest
   ```

2. **å¯ç”¨ Nginx é…ç½®**ï¼š
   å–æ¶ˆæ³¨é‡Š `nginx.conf` ä¸­çš„ brotli ç›¸å…³é…ç½®

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **CPU æ¶ˆè€—**ï¼šå‹ç¼©çº§åˆ«è¶Šé«˜ï¼ŒCPU æ¶ˆè€—è¶Šå¤§
2. **å…¼å®¹æ€§**ï¼šGzip æ”¯æŒæ‰€æœ‰ç°ä»£æµè§ˆå™¨ï¼ŒBrotli éœ€è¦ HTTPS
3. **ç¼“å­˜**ï¼šå‹ç¼©æ–‡ä»¶éœ€è¦æ­£ç¡®é…ç½®ç¼“å­˜ç­–ç•¥
4. **å°æ–‡ä»¶**ï¼šå°äºé˜ˆå€¼çš„æ–‡ä»¶ä¸å‹ç¼©ï¼ˆé¿å…å‹ç¼©å¼€é”€å¤§äºæ”¶ç›Šï¼‰

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šNginx æ²¡æœ‰å¯ç”¨å‹ç¼©

**æ£€æŸ¥**ï¼š
```bash
nginx -t  # æ£€æŸ¥é…ç½®è¯­æ³•
nginx -s reload  # é‡æ–°åŠ è½½é…ç½®
```

**æŸ¥çœ‹æ—¥å¿—**ï¼š
```bash
tail -f /var/log/nginx/error.log
```

### é—®é¢˜ 2ï¼šå‹ç¼©æ–‡ä»¶æœªç”Ÿæˆ

**æ£€æŸ¥**ï¼š
- ç¡®è®¤ `vite-plugin-compression` å·²å®‰è£…
- æ£€æŸ¥æ„å»ºæ—¥å¿—æ˜¯å¦æœ‰å‹ç¼©ç›¸å…³ä¿¡æ¯
- ç¡®è®¤æ–‡ä»¶å¤§å°è¶…è¿‡é˜ˆå€¼ï¼ˆ10KBï¼‰

### é—®é¢˜ 3ï¼šæµè§ˆå™¨æœªæ¥æ”¶å‹ç¼©å†…å®¹

**æ£€æŸ¥**ï¼š
- ç¡®è®¤è¯·æ±‚å¤´åŒ…å« `Accept-Encoding: gzip`
- æ£€æŸ¥ Nginx é…ç½®æ˜¯å¦æ­£ç¡®
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•

## ğŸ“š ç›¸å…³èµ„æº

- [Vite Compression Plugin](https://github.com/vbenjs/vite-plugin-compression)
- [Nginx Gzip æ–‡æ¡£](http://nginx.org/en/docs/http/ngx_http_gzip_module.html)
- [Brotli å‹ç¼©ç®—æ³•](https://github.com/google/brotli)

