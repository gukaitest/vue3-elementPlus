import{aQ as U,d as T,b as u,o as r,F as B,e as l,z as E,t as F,O as P,J as H,aj as V,r as M,a as W,f as G,g as J,aH as K}from"./index-DSrCSEjU.js";function Q(g,i){const p=new AbortController,m=p.signal,w=U({url:"upload/upload",method:"post",data:g,signal:m});return typeof i=="function"&&i(()=>p.abort()),w}function Y(g){return U({url:"upload/merge",method:"post",data:g})}function Z(g){return U({url:"upload/verify",method:"post",data:g})}const j={class:"list_item"},O={class:"left_box"},I={class:"left_box_fileName"},A={class:"left_box_percentage"},ee={class:"percentage_bac"},se={class:"percentage_box_span"},ne={class:"bottom_hint"},le={style:{"margin-left":"4px"}},te={key:0,style:{height:"24px",width:"100%"}},oe={key:1},ie={key:2},ae={key:3},ce={key:4},ue={key:5},re={key:6},he={class:"rightBtn"},de=["onClick"],pe=["onClick"],fe=["onClick"],_e=T({name:"ListItem",__name:"index",props:{uploadFileList:{}},emits:["pauseUpload","resumeUpload","cancelSingle"],setup(g,{emit:i}){const p=g,m=i,w=h=>{console.log("pauseUpload item",h),m("pauseUpload",h)},v=h=>{m("resumeUpload",h)},X=h=>{m("cancelSingle",h)},q=h=>{if(h>1048576){const f=Math.ceil(h/1048576),$=Math.ceil(f/1024);return $>1?`${$}G`:`${f}M`}return`${Math.ceil(h/1024)}KB`};return(h,k)=>(r(),u(B,null,[(r(!0),u(B,null,E(p.uploadFileList,t=>(r(),u("div",{key:t.id},[l("div",j,[l("div",O,[l("p",I,F(t.fileName),1),l("div",A,[l("div",ee,[l("div",{class:"percentage_box",style:P({width:`${t.percentage}%`})},null,4),l("div",se,[l("span",null,F(Math.floor(t.percentage))+"%",1)])]),l("div",ne,[l("div",null,[l("p",null,F(q(t.fileSize)),1)]),l("div",le,[t.state===0?(r(),u("div",te)):t.state===1?(r(),u("p",oe,"正在解析中...")):t.state===2?(r(),u("p",ie,"正在上传中...")):t.state===3?(r(),u("p",ae,"暂停中")):t.state===4?(r(),u("p",ce,"上传完成")):t.state===5?(r(),u("p",ue,"上传中断")):t.state===6?(r(),u("p",re,"上传失败")):H("",!0)])])])]),l("div",he,[[2].includes(t.state)?(r(),u("div",{key:0,class:"redBtn my_btn",onClick:f=>w(t)},"暂停",8,de)):H("",!0),[3,5].includes(t.state)?(r(),u("div",{key:1,class:"my_btn blueBtn",onClick:f=>v(t)},"继续",8,pe)):H("",!0),l("div",{class:"my_btn redBtn",onClick:f=>X(t)},"取消",8,fe)])])]))),128)),k[0]||(k[0]=l("div",{style:{height:"108px"}},null,-1))],64))}}),ge=V(_e,[["__scopeId","data-v-b85b704e"]]),ve={class:"page"},me={class:"page_top"},be={ref:"contentRef",class:"content"},ye={class:"bottom_box"},Ce={class:"input_btn"},R=1*1024*1024,ke=T({name:"personal-content_large-file-upload",__name:"index",setup(g){const i=M([]),p=M(6),m=W(()=>`${i.value.filter(n=>n.state!==4).length}/${i.value.length}`),w=e=>new Promise(n=>{const c=new Worker(new URL("/assets/hash-worker-C2P2qkGW.js",import.meta.url));c.postMessage({file:e,chunkSize:R}),c.onmessage=_=>{const{fileHash:a,fileChunkList:s}=_.data;a&&n({fileHash:a,fileChunkList:s})}}),v=(e,n=!0)=>{if([4,6].includes(e.state)||(n?e.state=3:e.state=5),e.errNumber=0,e.whileRequests.length>0){console.log("取消还在请求中的所有接口",e.whileRequests);for(const c of e.whileRequests)c.cancel&&c.cancel()}},X=async e=>{v(e),i.value=i.value.filter(n=>n.fileHash!==e.fileHash)},q=()=>{for(const e of i.value)v(e);i.value=[]},h=(e,n)=>{n.percentage=Number((n.finishNumber/e.chunkNumber*100).toFixed(2))},k=e=>{e.percentage=100,e.state=4},t=async e=>{const{fileName:n,fileHash:c}=e,_=await Y({chunkSize:R,fileName:n,fileHash:c}).catch(()=>{});_&&_.response.data.code==="0000"?(k(e),console.log("文件合并成功！")):(v(e,!0),console.log("文件合并失败！")),e.finishNumber=0},f=e=>{if(console.log("单个文件上传"),e.allChunkList.length===0||e.whileRequests.length>0)return!1;const n=i.value.filter(a=>a.state===1||a.state===2);p.value=Math.ceil(6/n.length);const c=e.allChunkList.slice(-p.value);e.whileRequests.push(...c),e.allChunkList.length>p.value?e.allChunkList.splice(-p.value):e.allChunkList=[];const _=async a=>{const s=new FormData,{fileHash:o,fileSize:b,fileName:x,index:y,chunkFile:S,chunkHash:C,chunkSize:z,chunkNumber:L}=a;s.append("fileHash",o),s.append("fileSize",String(b)),s.append("fileName",x),s.append("index",String(y)),s.append("chunkFile",S),s.append("chunkHash",C),s.append("chunkSize",String(z)),s.append("chunkNumber",String(L)),console.log("单个分片请求",s);try{const d=await Q(s,N=>{a.cancel=N});if(e.state===3||e.state===5)return!1;if(!d||d.response.data.code!=="0000")return e.errNumber+=1,e.errNumber>3?(console.log("切片上传失败超过三次了"),v(e,!1),!1):(console.log("切片上传失败还没超过3次"),_(a));if(d.response.data.code==="0000")return e.errNumber=Math.max(e.errNumber-1,0),e.finishNumber+=1,a.finish=!0,h(a,e),e.whileRequests=e.whileRequests.filter(N=>N.chunkFile!==a.chunkFile),e.finishNumber===L?t(e):f(e),!0}catch(d){return console.error("切片上传请求异常",d),!1}};for(const a of c)console.log("XXXXXXXXXXXXXXXX单个切片上传",a),_(a);return!0},$=e=>{e.state=2,e.allChunkList.push(...e.whileRequests),e.whileRequests=[],f(e)},D=async e=>{const n=e.target;if(!n||!n.files||n.files.length===0)return!1;const c=n.files;return Array.from(c).forEach(async(_,a)=>{const s=_,o=K({id:`${new Date().getTime()}${a}`,state:0,fileHash:"",fileName:s.name,fileSize:s.size,allChunkList:[],whileRequests:[],finishNumber:0,errNumber:0,percentage:0,cancel:null});i.value.push(o),o.state=1,s.size===0&&(o.state=6,v(o,!1)),console.log("文件开始解析");const{fileHash:b,fileChunkList:x}=await w(s);console.log(b,"文件hash计算完成");let y="";const S=s.name.lastIndexOf(".");S===-1&&(y=s.name),y=s.name.slice(0,S),o.fileHash=`${b}${y}`,o.state=2,console.log(i.value,"uploadFileList.value");try{const C=await Z({fileHash:`${b}${y}`,fileName:s.name});if(console.log("res",C),C.response.data.code==="0000"){const{shouldUpload:z,uploadedList:L}=C.data;if(!z)return k(o),console.log("文件已存在，实现秒传"),!1;if(o.allChunkList=x.map((d,N)=>({fileHash:`${b}${y}`,fileSize:s.size,fileName:s.name,index:N,chunkFile:d.chunkFile,chunkHash:`${b}-${N}`,chunkSize:R,chunkNumber:x.length,finish:!1})),L.length>0){if(o.allChunkList=o.allChunkList.filter(d=>!L.includes(d.chunkHash)),!o.allChunkList.length)return await t(o),!1;o.allChunkList=o.allChunkList.map(d=>({...d,chunkNumber:o.allChunkList.length}))}console.log("文件开始切片"),f(o)}}catch(C){console.error("文件检查失败",C),o.state=6}return!0}),!0};return(e,n)=>{const c=ge;return r(),u("div",ve,[l("div",me,[l("div",null,"正在上传 ("+F(m.value)+")",1),l("div",{class:"page_top_right",style:P({"justify-content":i.value.length>1?"space-between":"flex-end"})},[i.value.length>1?(r(),u("p",{key:0,class:"clear_btn",onClick:q},"全部取消")):H("",!0)],4)]),l("div",be,[G(c,{"upload-file-list":i.value,onPauseUpload:v,onResumeUpload:$,onCancelSingle:X},null,8,["upload-file-list"])],512),l("div",ye,[l("div",Ce,[n[0]||(n[0]=J(" 上传文件 ")),l("input",{type:"file",multiple:"",class:"is_input",onChange:D},null,32)])])])}}}),we=V(ke,[["__scopeId","data-v-0a4ea2b7"]]);export{we as default};
