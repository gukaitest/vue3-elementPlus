import{r as O,t as p,v as u,F as J,y as l,al as ne,ao as L,H as A,z as D,K as M,J as W,D as m,E as R,P as S,an as g,C as I,R as Y,s as E,bX as te,bo as ae,aC as oe,bY as ie,b6 as Q,a9 as ce}from"./vue-vendor-DLKW-W3j.js";import{s as Z,j as ee}from"./index-BBz38mVY.js";function ue(y,t){const _=new AbortController,$=_.signal,z=Z({url:"upload/upload",method:"post",data:y,signal:$});return typeof t=="function"&&t(()=>_.abort()),z}function re(y){return Z({url:"upload/merge",method:"post",data:y})}function de(y){return Z({url:"upload/verify",method:"post",data:y})}const fe={class:"list_item"},pe={class:"left_box"},he={class:"left_box_fileName"},ge={class:"left_box_percentage"},_e={class:"percentage_bac"},ve={class:"percentage_box_span"},me={class:"bottom_hint"},ye={style:{"margin-left":"4px"}},be={key:0,style:{height:"24px",width:"100%"}},Ce={key:1},ke={key:2},$e={key:3},Ne={key:4},we={key:5},xe={key:6},Le={class:"rightBtn"},Se=O({name:"ListItem",__name:"index",props:{uploadFileList:{}},emits:["pauseUpload","resumeUpload","cancelSingle"],setup(y,{emit:t}){const _=y,$=t,z=i=>{console.log("pauseUpload item",i),$("pauseUpload",i)},F=i=>{$("resumeUpload",i)},P=i=>{i.state!==4&&$("cancelSingle",i)},H=i=>i.state!==4,b=i=>{if(i>1048576){const C=Math.ceil(i/1048576),X=Math.ceil(C/1024);return X>1?`${X}G`:`${C}M`}return`${Math.ceil(i/1024)}KB`};return(i,f)=>(u(),p(J,null,[(u(!0),p(J,null,ne(_.uploadFileList,n=>(u(),p("div",{key:n.id},[l("div",fe,[l("div",pe,[l("p",he,L(n.fileName),1),l("div",ge,[l("div",_e,[l("div",{class:"percentage_box",style:A({width:`${n.percentage}%`})},null,4),l("div",ve,[l("span",null,L(Math.floor(n.percentage))+"%",1)])]),l("div",me,[l("div",null,[l("p",null,L(b(n.fileSize)),1)]),l("div",ye,[n.state===0?(u(),p("div",be)):n.state===1?(u(),p("p",Ce,"æ­£åœ¨è§£æä¸­...")):n.state===2?(u(),p("p",ke,"æ­£åœ¨ä¸Šä¼ ä¸­...")):n.state===3?(u(),p("p",$e,"æš‚åœä¸­")):n.state===4?(u(),p("p",Ne,"ä¸Šä¼ å®Œæˆ")):n.state===5?(u(),p("p",we,"ä¸Šä¼ ä¸­æ–­")):n.state===6?(u(),p("p",xe,"ä¸Šä¼ å¤±è´¥")):D("",!0)])])])]),l("div",Le,[[2].includes(n.state)?(u(),M(m(R),{key:0,type:"warning",size:"small",plain:"",onClick:C=>z(n)},{default:S(()=>f[0]||(f[0]=[g(" æš‚åœ ")])),_:2},1032,["onClick"])):D("",!0),[3,5].includes(n.state)?(u(),M(m(R),{key:1,type:"primary",size:"small",plain:"",onClick:C=>F(n)},{default:S(()=>f[1]||(f[1]=[g(" ç»§ç»­ ")])),_:2},1032,["onClick"])):D("",!0),W(m(R),{type:"danger",size:"small",plain:"",disabled:!H(n),class:I({"cancel-btn-disabled":!H(n)}),onClick:C=>P(n)},{default:S(()=>f[2]||(f[2]=[g(" å–æ¶ˆ ")])),_:2},1032,["disabled","class","onClick"])])])]))),128)),f[3]||(f[3]=l("div",{style:{height:"108px"}},null,-1))],64))}}),ze=ee(Se,[["__scopeId","data-v-9cd66126"]]),Fe={class:"page"},Xe={class:"page_top"},Me={class:"page_top_left"},Re={class:"upload-status"},He={class:"status-count"},Ue={ref:"contentRef",class:"content"},qe={class:"bottom_box"},Be={class:"upload-area"},Ee={class:"input_btn"},j=100*1024*1024,T=100,K=1*1024*1024,Te=O({name:"personal-content_large-file-upload",__name:"index",setup(y){const t=Y([]),_=Y(6),$=E(()=>`${t.value.filter(s=>s.state!==4).length}/${t.value.length}`),z=E(()=>t.value.some(e=>[1,2].includes(e.state))),F=E(()=>t.value.length===0?!1:t.value.some(e=>e.state!==4)),P=E(()=>({justifyContent:t.value.length>1?"space-between":"flex-end"})),H=e=>new Promise(s=>{const d=new Worker(new URL("/assets/hash-worker-BoeFmuqm.js",import.meta.url),{type:"module"});d.postMessage({file:e,chunkSize:K}),d.onmessage=h=>{const{fileHash:a,fileChunkList:c}=h.data;a&&s({fileHash:a,fileChunkList:c})}}),b=(e,s=!0)=>{if([4,6].includes(e.state)||(s?e.state=3:e.state=5),e.errNumber=0,e.whileRequests.length>0){console.log("å–æ¶ˆè¿˜åœ¨è¯·æ±‚ä¸­çš„æ‰€æœ‰æ¥å£",e.whileRequests);for(const d of e.whileRequests)d.cancel&&d.cancel()}},i=async e=>{b(e),t.value=t.value.filter(s=>s.fileHash!==e.fileHash)},f=()=>{if(F.value){for(const e of t.value)b(e);t.value=[]}},n=(e,s)=>{s.percentage=Number((s.finishNumber/e.chunkNumber*100).toFixed(2))},C=e=>{e.percentage=100,e.state=4},X=async e=>{const{fileName:s,fileHash:d}=e,h=await re({chunkSize:K,fileName:s,fileHash:d}).catch(()=>{});h&&h.response.data.code==="0000"?(C(e),console.log("æ–‡ä»¶åˆå¹¶æˆåŠŸï¼")):(b(e,!0),console.log("æ–‡ä»¶åˆå¹¶å¤±è´¥ï¼")),e.finishNumber=0},V=e=>{if(console.log("å•ä¸ªæ–‡ä»¶ä¸Šä¼ "),e.allChunkList.length===0||e.whileRequests.length>0)return!1;const s=t.value.filter(a=>a.state===1||a.state===2);_.value=Math.ceil(6/s.length);const d=e.allChunkList.slice(-_.value);e.whileRequests.push(...d),e.allChunkList.length>_.value?e.allChunkList.splice(-_.value):e.allChunkList=[];const h=async a=>{const c=new FormData,{fileHash:r,fileSize:o,fileName:N,index:U,chunkFile:w,chunkHash:q,chunkSize:x,chunkNumber:B}=a;c.append("fileHash",r),c.append("fileSize",String(o)),c.append("fileName",N),c.append("index",String(U)),c.append("chunkFile",w),c.append("chunkHash",q),c.append("chunkSize",String(x)),c.append("chunkNumber",String(B)),console.log("å•ä¸ªåˆ†ç‰‡è¯·æ±‚",c);try{const k=await ue(c,v=>{a.cancel=v});if(e.state===3||e.state===5)return!1;if(!k||k.response.data.code!=="0000")return e.errNumber+=1,e.errNumber>3?(console.log("åˆ‡ç‰‡ä¸Šä¼ å¤±è´¥è¶…è¿‡ä¸‰æ¬¡äº†"),b(e,!1),!1):(console.log("åˆ‡ç‰‡ä¸Šä¼ å¤±è´¥è¿˜æ²¡è¶…è¿‡3æ¬¡"),h(a));if(k.response.data.code==="0000")return e.errNumber=Math.max(e.errNumber-1,0),e.finishNumber+=1,a.finish=!0,n(a,e),e.whileRequests=e.whileRequests.filter(v=>v.chunkFile!==a.chunkFile),e.finishNumber===B?X(e):V(e),!0}catch(k){return console.error("åˆ‡ç‰‡ä¸Šä¼ è¯·æ±‚å¼‚å¸¸",k),!1}};for(const a of d)console.log("XXXXXXXXXXXXXXXXå•ä¸ªåˆ‡ç‰‡ä¸Šä¼ ",a),h(a);return!0},se=e=>{e.state=2,e.allChunkList.push(...e.whileRequests),e.whileRequests=[],V(e)},le=async e=>{const s=e.target;if(!s||!s.files||s.files.length===0)return!1;const d=s.files,h=Array.from(d).filter(a=>a.size>j);if(h.length>0){const a=h.map(c=>c.name).join(", ");return Q.error(`æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼š${a}ã€‚è¯·ä¸Šä¼ å°äº${T}MBçš„æ–‡ä»¶ã€‚`),s.value="",!1}return Array.from(d).forEach(async(a,c)=>{const r=a;if(r.size>j)return Q.error(`æ–‡ä»¶ "${r.name}" å¤§å°è¶…è¿‡${T}MBé™åˆ¶ï¼Œå·²è·³è¿‡ä¸Šä¼ ã€‚`),!1;const o=ce({id:`${new Date().getTime()}${c}`,state:0,fileHash:"",fileName:r.name,fileSize:r.size,allChunkList:[],whileRequests:[],finishNumber:0,errNumber:0,percentage:0,cancel:null});t.value.push(o),o.state=1,r.size===0&&(o.state=6,b(o,!1)),console.log("æ–‡ä»¶å¼€å§‹è§£æ");const{fileHash:N,fileChunkList:U}=await H(r);console.log(N,"æ–‡ä»¶hashè®¡ç®—å®Œæˆ");let w="";const q=r.name.lastIndexOf(".");q===-1&&(w=r.name),w=r.name.slice(0,q),o.fileHash=`${N}${w}`,o.state=2,console.log(t.value,"uploadFileList.value");try{const x=await de({fileHash:`${N}${w}`,fileName:r.name});if(console.log("res============",x),x.response.data.code==="0000"){const{shouldUpload:B,uploadedList:k}=x.data;if(!B)return C(o),console.log("æ–‡ä»¶å·²å­˜åœ¨ï¼Œå®ç°ç§’ä¼ "),!1;if(o.allChunkList=U.map((v,G)=>({fileHash:`${N}${w}`,fileSize:r.size,fileName:r.name,index:G,chunkFile:v.chunkFile,chunkHash:`${N}-${G}`,chunkSize:K,chunkNumber:U.length,finish:!1})),k.length>0){if(o.allChunkList=o.allChunkList.filter(v=>!k.includes(v.chunkHash)),!o.allChunkList.length)return await X(o),!1;o.allChunkList=o.allChunkList.map(v=>({...v,chunkNumber:o.allChunkList.length}))}console.log("æ–‡ä»¶å¼€å§‹åˆ‡ç‰‡"),V(o)}}catch(x){console.error("æ–‡ä»¶æ£€æŸ¥å¤±è´¥",x),o.state=6}return!0}),!0};return(e,s)=>(u(),p("div",Fe,[W(m(ae),{closable:!1,type:"info",icon:m(te),class:"demo-notice"},{default:S(()=>[l("span",{class:"notice-text"},[s[0]||(s[0]=g(" æœåŠ¡å™¨å†…å­˜é™åˆ¶ï¼Œè¯·ä¸Šä¼ å°äº ")),l("strong",null,L(T)+"MB"),s[1]||(s[1]=g(" çš„æ–‡ä»¶ã€‚è¶…è¿‡é™åˆ¶çš„æ–‡ä»¶å°†è¢«æ‹’ç»ä¸Šä¼ ã€‚ "))])]),_:1},8,["icon"]),l("div",Xe,[l("div",Me,[l("span",Re,[s[2]||(s[2]=g(" æ­£åœ¨ä¸Šä¼  ")),l("span",He,"("+L($.value)+")",1)])]),l("div",{class:"page_top_right",style:A(P.value)},[t.value.length>1?(u(),M(m(R),{key:0,type:"danger",size:"small",plain:"",disabled:!F.value,class:I({"cancel-all-btn-disabled":!F.value}),onClick:f},{default:S(()=>s[3]||(s[3]=[g(" å…¨éƒ¨å–æ¶ˆ ")])),_:1},8,["disabled","class"])):D("",!0)],4)]),l("div",Ue,[t.value.length>0?(u(),M(ze,{key:0,"upload-file-list":t.value,onPauseUpload:b,onResumeUpload:se,onCancelSingle:i},null,8,["upload-file-list"])):(u(),M(m(oe),{key:1,description:"æš‚æ— ä¸Šä¼ æ–‡ä»¶","image-size":120,class:"empty-state"},{description:S(()=>s[4]||(s[4]=[l("p",{class:"empty-text"},"ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶å¼€å§‹ä¸Šä¼ ",-1)])),_:1}))],512),l("div",qe,[l("div",Be,[l("div",Ee,[W(m(R),{type:"primary",icon:z.value?void 0:m(ie)},{default:S(()=>[g(L(z.value?"ç»§ç»­æ·»åŠ æ–‡ä»¶":"é€‰æ‹©æ–‡ä»¶"),1)]),_:1},8,["icon"]),l("input",{type:"file",multiple:"",class:"is_input",accept:"*/*","aria-label":"é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶",onChange:le},null,32)]),l("div",{class:"file-info"},[s[6]||(s[6]=l("span",{class:"info-item"},[l("i",{class:"info-icon"},"ğŸ“„"),g(" æ”¯æŒæ ¼å¼ï¼šä»»æ„æ–‡ä»¶ ")],-1)),l("span",{class:"info-item"},[s[5]||(s[5]=l("i",{class:"info-icon"},"ğŸ“¦",-1)),g(" å¤§å°é™åˆ¶ï¼š"+L(T)+"MB ")])])])])]))}}),Ve=ee(Te,[["__scopeId","data-v-cef8deff"]]);export{Ve as default};
