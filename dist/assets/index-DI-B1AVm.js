import{aU as R,d as D,b as r,o as h,F as E,e as s,z as J,t as w,O as W,J as M,aj as G,r as T,a as K,f as Q,g as Y,aV as V,aH as j}from"./index-q4uhLKit.js";function O(v,i){const p=new AbortController,y=p.signal,L=R({url:"upload/upload",method:"post",data:v,signal:y});return typeof i=="function"&&i(()=>p.abort()),L}function I(v){return R({url:"upload/merge",method:"post",data:v})}function A(v){return R({url:"upload/verify",method:"post",data:v})}const ee={class:"list_item"},se={class:"left_box"},ne={class:"left_box_fileName"},le={class:"left_box_percentage"},te={class:"percentage_bac"},oe={class:"percentage_box_span"},ie={class:"bottom_hint"},ae={style:{"margin-left":"4px"}},ce={key:0,style:{height:"24px",width:"100%"}},ue={key:1},re={key:2},he={key:3},de={key:4},fe={key:5},pe={key:6},_e={class:"rightBtn"},ge=["onClick"],ve=["onClick"],me=["onClick"],be=D({name:"ListItem",__name:"index",props:{uploadFileList:{}},emits:["pauseUpload","resumeUpload","cancelSingle"],setup(v,{emit:i}){const p=v,y=i,L=d=>{console.log("pauseUpload item",d),y("pauseUpload",d)},m=d=>{y("resumeUpload",d)},H=d=>{y("cancelSingle",d)},U=d=>{if(d>1048576){const _=Math.ceil(d/1048576),x=Math.ceil(_/1024);return x>1?`${x}G`:`${_}M`}return`${Math.ceil(d/1024)}KB`};return(d,$)=>(h(),r(E,null,[(h(!0),r(E,null,J(p.uploadFileList,l=>(h(),r("div",{key:l.id},[s("div",ee,[s("div",se,[s("p",ne,w(l.fileName),1),s("div",le,[s("div",te,[s("div",{class:"percentage_box",style:W({width:`${l.percentage}%`})},null,4),s("div",oe,[s("span",null,w(Math.floor(l.percentage))+"%",1)])]),s("div",ie,[s("div",null,[s("p",null,w(U(l.fileSize)),1)]),s("div",ae,[l.state===0?(h(),r("div",ce)):l.state===1?(h(),r("p",ue,"正在解析中...")):l.state===2?(h(),r("p",re,"正在上传中...")):l.state===3?(h(),r("p",he,"暂停中")):l.state===4?(h(),r("p",de,"上传完成")):l.state===5?(h(),r("p",fe,"上传中断")):l.state===6?(h(),r("p",pe,"上传失败")):M("",!0)])])])]),s("div",_e,[[2].includes(l.state)?(h(),r("div",{key:0,class:"redBtn my_btn",onClick:_=>L(l)},"暂停",8,ge)):M("",!0),[3,5].includes(l.state)?(h(),r("div",{key:1,class:"my_btn blueBtn",onClick:_=>m(l)},"继续",8,ve)):M("",!0),s("div",{class:"my_btn redBtn",onClick:_=>H(l)},"取消",8,me)])])]))),128)),$[0]||($[0]=s("div",{style:{height:"108px"}},null,-1))],64))}}),ye=G(be,[["__scopeId","data-v-b85b704e"]]),Ce={class:"page"},ke={class:"page_top"},Ne={ref:"contentRef",class:"content"},$e={class:"bottom_box"},we={class:"input_btn"},P=100*1024*1024,X=100,q=1*1024*1024,Le=D({name:"personal-content_large-file-upload",__name:"index",setup(v){const i=T([]),p=T(6),y=K(()=>`${i.value.filter(n=>n.state!==4).length}/${i.value.length}`),L=e=>new Promise(n=>{const c=new Worker(new URL("/assets/hash-worker-C2P2qkGW.js",import.meta.url));c.postMessage({file:e,chunkSize:q}),c.onmessage=f=>{const{fileHash:t,fileChunkList:a}=f.data;t&&n({fileHash:t,fileChunkList:a})}}),m=(e,n=!0)=>{if([4,6].includes(e.state)||(n?e.state=3:e.state=5),e.errNumber=0,e.whileRequests.length>0){console.log("取消还在请求中的所有接口",e.whileRequests);for(const c of e.whileRequests)c.cancel&&c.cancel()}},H=async e=>{m(e),i.value=i.value.filter(n=>n.fileHash!==e.fileHash)},U=()=>{for(const e of i.value)m(e);i.value=[]},d=(e,n)=>{n.percentage=Number((n.finishNumber/e.chunkNumber*100).toFixed(2))},$=e=>{e.percentage=100,e.state=4},l=async e=>{const{fileName:n,fileHash:c}=e,f=await I({chunkSize:q,fileName:n,fileHash:c}).catch(()=>{});f&&f.response.data.code==="0000"?($(e),console.log("文件合并成功！")):(m(e,!0),console.log("文件合并失败！")),e.finishNumber=0},_=e=>{if(console.log("单个文件上传"),e.allChunkList.length===0||e.whileRequests.length>0)return!1;const n=i.value.filter(t=>t.state===1||t.state===2);p.value=Math.ceil(6/n.length);const c=e.allChunkList.slice(-p.value);e.whileRequests.push(...c),e.allChunkList.length>p.value?e.allChunkList.splice(-p.value):e.allChunkList=[];const f=async t=>{const a=new FormData,{fileHash:u,fileSize:o,fileName:C,index:S,chunkFile:k,chunkHash:F,chunkSize:N,chunkNumber:z}=t;a.append("fileHash",u),a.append("fileSize",String(o)),a.append("fileName",C),a.append("index",String(S)),a.append("chunkFile",k),a.append("chunkHash",F),a.append("chunkSize",String(N)),a.append("chunkNumber",String(z)),console.log("单个分片请求",a);try{const b=await O(a,g=>{t.cancel=g});if(e.state===3||e.state===5)return!1;if(!b||b.response.data.code!=="0000")return e.errNumber+=1,e.errNumber>3?(console.log("切片上传失败超过三次了"),m(e,!1),!1):(console.log("切片上传失败还没超过3次"),f(t));if(b.response.data.code==="0000")return e.errNumber=Math.max(e.errNumber-1,0),e.finishNumber+=1,t.finish=!0,d(t,e),e.whileRequests=e.whileRequests.filter(g=>g.chunkFile!==t.chunkFile),e.finishNumber===z?l(e):_(e),!0}catch(b){return console.error("切片上传请求异常",b),!1}};for(const t of c)console.log("XXXXXXXXXXXXXXXX单个切片上传",t),f(t);return!0},x=e=>{e.state=2,e.allChunkList.push(...e.whileRequests),e.whileRequests=[],_(e)},Z=async e=>{const n=e.target;if(!n||!n.files||n.files.length===0)return!1;const c=n.files,f=Array.from(c).filter(t=>t.size>P);if(f.length>0){const t=f.map(a=>a.name).join(", ");return V.error(`文件大小超过限制：${t}。请上传小于${X}MB的文件。`),n.value="",!1}return Array.from(c).forEach(async(t,a)=>{const u=t;if(u.size>P)return V.error(`文件 "${u.name}" 大小超过${X}MB限制，已跳过上传。`),!1;const o=j({id:`${new Date().getTime()}${a}`,state:0,fileHash:"",fileName:u.name,fileSize:u.size,allChunkList:[],whileRequests:[],finishNumber:0,errNumber:0,percentage:0,cancel:null});i.value.push(o),o.state=1,u.size===0&&(o.state=6,m(o,!1)),console.log("文件开始解析");const{fileHash:C,fileChunkList:S}=await L(u);console.log(C,"文件hash计算完成");let k="";const F=u.name.lastIndexOf(".");F===-1&&(k=u.name),k=u.name.slice(0,F),o.fileHash=`${C}${k}`,o.state=2,console.log(i.value,"uploadFileList.value");try{const N=await A({fileHash:`${C}${k}`,fileName:u.name});if(console.log("res",N),N.response.data.code==="0000"){const{shouldUpload:z,uploadedList:b}=N.data;if(!z)return $(o),console.log("文件已存在，实现秒传"),!1;if(o.allChunkList=S.map((g,B)=>({fileHash:`${C}${k}`,fileSize:u.size,fileName:u.name,index:B,chunkFile:g.chunkFile,chunkHash:`${C}-${B}`,chunkSize:q,chunkNumber:S.length,finish:!1})),b.length>0){if(o.allChunkList=o.allChunkList.filter(g=>!b.includes(g.chunkHash)),!o.allChunkList.length)return await l(o),!1;o.allChunkList=o.allChunkList.map(g=>({...g,chunkNumber:o.allChunkList.length}))}console.log("文件开始切片"),_(o)}}catch(N){console.error("文件检查失败",N),o.state=6}return!0}),!0};return(e,n)=>{const c=ye;return h(),r("div",Ce,[s("div",{class:"demo-notice"},[s("div",{class:"notice-content"},[n[0]||(n[0]=s("i",{class:"el-icon-info"},null,-1)),s("span",null,"功能演示：请上传小于"+w(X)+"MB的文件。超过限制的文件将被拒绝上传。")])]),s("div",ke,[s("div",null,"正在上传 ("+w(y.value)+")",1),s("div",{class:"page_top_right",style:W({"justify-content":i.value.length>1?"space-between":"flex-end"})},[i.value.length>1?(h(),r("p",{key:0,class:"clear_btn",onClick:U},"全部取消")):M("",!0)],4)]),s("div",Ne,[Q(c,{"upload-file-list":i.value,onPauseUpload:m,onResumeUpload:x,onCancelSingle:H},null,8,["upload-file-list"])],512),s("div",$e,[s("div",we,[n[1]||(n[1]=Y(" 上传文件 ")),s("input",{type:"file",multiple:"",class:"is_input",onChange:Z},null,32)]),s("div",{class:"file-info"},[n[2]||(n[2]=s("span",null,"支持格式：任意文件",-1)),s("span",null,"大小限制："+w(X)+"MB")])])])}}}),Se=G(Le,[["__scopeId","data-v-05f6a686"]]);export{Se as default};
