# Vue3-ElementPlus 国际化语言切换功能详细说明

## 目录

- [概述](#概述)
- [核心架构](#核心架构)
- [文件结构](#文件结构)
- [核心逻辑详解](#核心逻辑详解)
- [使用指南](#使用指南)
- [扩展说明](#扩展说明)

---

## 概述

本项目基于 Vue3 + Element Plus + TypeScript 实现了一套完整的国际化（i18n）语言切换功能。支持中文（zh-CN）和英文（en-US）两种语言，并提供了完整的类型定义和响应式更新机制。

### 技术栈

- **vue-i18n**: Vue3 官方国际化插件
- **Pinia**: 状态管理
- **Element Plus**: UI 组件库（支持多语言）
- **dayjs**: 日期时间库（支持多语言）

---

## 核心架构

### 架构流程图

```
用户点击语言切换按钮
    ↓
LangSwitch 组件触发 changeLang 事件
    ↓
AppStore.changeLocale() 方法
    ↓
┌─────────────────────────────────────┐
│  1. 更新 Pinia Store 中的 locale    │
│  2. 调用 setLocale() 更新 vue-i18n  │
│  3. 保存到 localStorage            │
└─────────────────────────────────────┘
    ↓
watch 监听器触发
    ↓
┌─────────────────────────────────────┐
│  自动更新：                          │
│  - 文档标题 (document title)        │
│  - 全局菜单 (global menus)          │
│  - 标签页 (tabs)                    │
│  - dayjs 本地化                     │
└─────────────────────────────────────┘
```

---

## 文件结构

```
vue3-elementPlus/
├── src/
│   ├── locales/                    # 国际化核心目录
│   │   ├── index.ts                # i18n 实例创建和导出
│   │   ├── locale.ts               # 语言资源聚合
│   │   ├── ui.ts                   # Element Plus UI 组件本地化
│   │   ├── dayjs.ts                # dayjs 日期库本地化
│   │   └── langs/                  # 语言文件目录
│   │       ├── zh-cn.ts           # 中文语言包
│   │       └── en-us.ts           # 英文语言包
│   │
│   ├── store/
│   │   └── modules/
│   │       └── app/
│   │           └── index.ts        # App Store（包含语言状态管理）
│   │
│   ├── components/
│   │   └── common/
│   │       └── lang-switch.vue     # 语言切换组件
│   │
│   ├── layouts/
│   │   └── modules/
│   │       └── global-header/
│   │           └── index.vue       # 全局头部（包含语言切换按钮）
│   │
│   └── typings/
│       └── app.d.ts                # TypeScript 类型定义
```

---

## 核心逻辑详解

### 1. 语言文件定义 (`src/locales/langs/`)

#### 1.1 中文语言包 (`zh-cn.ts`)

```typescript
const local: App.I18n.Schema = {
  system: {
    title: "Soybean 管理系统",
    updateTitle: "系统版本更新通知",
    // ...
  },
  common: {
    action: "操作",
    add: "新增",
    // ...
  },
  // ... 更多模块
};

export default local;
```

#### 1.2 英文语言包 (`en-us.ts`)

```typescript
const local: App.I18n.Schema = {
  system: {
    title: "SoybeanAdmin",
    updateTitle: "System Version Update Notification",
    // ...
  },
  common: {
    action: "Action",
    add: "Add",
    // ...
  },
  // ... 更多模块
};

export default local;
```

**特点**：

- 两个语言文件结构完全一致，通过 TypeScript 类型 `App.I18n.Schema` 保证类型安全
- 支持嵌套对象结构，便于组织大量翻译文本
- 支持参数插值（如 `{userName}`）

---

### 2. 语言资源聚合 (`src/locales/locale.ts`)

```typescript
import zhCN from "./langs/zh-cn";
import enUS from "./langs/en-us";

const locales: Record<App.I18n.LangType, App.I18n.Schema> = {
  "zh-CN": zhCN,
  "en-US": enUS,
};

export default locales;
```

**作用**：

- 将所有语言文件聚合到一个对象中
- 使用 `Record<LangType, Schema>` 确保类型安全
- 作为 vue-i18n 的 `messages` 参数

---

### 3. i18n 实例创建 (`src/locales/index.ts`)

```typescript
import type { App } from "vue";
import { createI18n } from "vue-i18n";
import { localStg } from "@/utils/storage";
import messages from "./locale";

const i18n = createI18n({
  locale: localStg.get("lang") || "zh-CN", // 从 localStorage 读取或默认中文
  fallbackLocale: "en", // 回退语言
  messages, // 语言资源
  legacy: false, // 使用 Composition API 模式
});

/**
 * Setup plugin i18n
 */
export function setupI18n(app: App) {
  app.use(i18n);
}

// 导出翻译函数（带类型）
export const $t = i18n.global.t as App.I18n.$T;

/**
 * 设置当前语言
 */
export function setLocale(locale: App.I18n.LangType) {
  i18n.global.locale.value = locale;
}
```

**关键点**：

1. **初始化语言**：从 `localStorage` 读取用户上次选择的语言，如果没有则默认使用中文
2. **回退机制**：如果当前语言找不到翻译，会回退到英文
3. **Composition API**：`legacy: false` 表示使用 Vue3 的 Composition API 模式
4. **类型安全**：`$t` 函数通过类型断言获得完整的类型提示

---

### 4. 状态管理 (`src/store/modules/app/index.ts`)

#### 4.1 语言状态定义

```typescript
import { ref, watch } from "vue";
import { defineStore } from "pinia";
import { $t, setLocale } from "@/locales";
import { setDayjsLocale } from "@/locales/dayjs";

export const useAppStore = defineStore(SetupStoreId.App, () => {
  // 当前语言（响应式）
  const locale = ref<App.I18n.LangType>(localStg.get("lang") || "zh-CN");

  // 语言选项列表
  const localeOptions: App.I18n.LangOption[] = [
    { label: "中文", key: "zh-CN" },
    { label: "English", key: "en-US" },
  ];

  // 切换语言的核心方法
  function changeLocale(lang: App.I18n.LangType) {
    locale.value = lang; // 1. 更新 Pinia Store
    setLocale(lang); // 2. 更新 vue-i18n
    localStg.set("lang", lang); // 3. 持久化到 localStorage
  }

  // ... 其他代码
});
```

#### 4.2 响应式更新机制

```typescript
// watch store
scope.run(() => {
  // 监听语言变化
  watch(locale, () => {
    // 1. 更新文档标题
    updateDocumentTitleByLocale();

    // 2. 更新全局菜单
    routeStore.updateGlobalMenusByLocale();

    // 3. 更新标签页
    tabStore.updateTabsByLocale();

    // 4. 设置 dayjs 本地化
    setDayjsLocale(locale.value);
  });
});
```

**响应式更新流程**：

1. **文档标题更新**：

   ```typescript
   function updateDocumentTitleByLocale() {
     const { i18nKey, title } = router.currentRoute.value.meta;
     const documentTitle = i18nKey ? $t(i18nKey) : title;
     useTitle(documentTitle);
   }
   ```

2. **菜单更新**：

   ```typescript
   // src/store/modules/route/shared.ts
   export function updateLocaleOfGlobalMenus(menus: App.Global.Menu[]) {
     const result: App.Global.Menu[] = [];
     menus.forEach((menu) => {
       const { i18nKey, label, children } = menu;
       const newLabel = i18nKey ? $t(i18nKey) : label; // 使用 i18nKey 重新翻译
       const newMenu: App.Global.Menu = {
         ...menu,
         label: newLabel,
       };
       if (children?.length) {
         newMenu.children = updateLocaleOfGlobalMenus(children); // 递归更新子菜单
       }
       result.push(newMenu);
     });
     return result;
   }
   ```

3. **标签页更新**：类似菜单更新逻辑，通过 `i18nKey` 重新翻译标签页标题

4. **dayjs 本地化**：

   ```typescript
   // src/locales/dayjs.ts
   export function setDayjsLocale(lang: App.I18n.LangType = "zh-CN") {
     const localMap = {
       "zh-CN": "zh-cn",
       "en-US": "en",
     } satisfies Record<App.I18n.LangType, string>;

     const l = lang || localStg.get("lang") || "zh-CN";
     locale(localMap[l]); // 设置 dayjs 的本地化语言
   }
   ```

---

### 5. UI 组件本地化 (`src/locales/ui.ts`)

```typescript
import zhCn from "element-plus/dist/locale/zh-cn.mjs";
import en from "element-plus/dist/locale/en.mjs";

export const UILocales: any = {
  "zh-CN": zhCn,
  "en-US": en,
};
```

**作用**：为 Element Plus 组件库提供本地化支持，确保日期选择器、分页器等组件的文本显示正确。

---

### 6. 语言切换组件 (`src/components/common/lang-switch.vue`)

```vue
<script setup lang="ts">
import { computed } from "vue";
import { $t } from "@/locales";

interface Props {
  lang: App.I18n.LangType; // 当前语言
  langOptions: App.I18n.LangOption[]; // 语言选项列表
  showTooltip?: boolean; // 是否显示提示
}

const props = withDefaults(defineProps<Props>(), {
  showTooltip: true,
});

type Emits = {
  (e: "changeLang", lang: App.I18n.LangType): void;
};

const emit = defineEmits<Emits>();

const tooltipContent = computed(() => {
  if (!props.showTooltip) return "";
  return $t("icon.lang"); // 使用 i18n 翻译提示文本
});

function changeLang(lang: App.I18n.LangType) {
  emit("changeLang", lang); // 触发语言切换事件
}
</script>

<template>
  <ElDropdown trigger="click">
    <div>
      <ButtonIcon :tooltip-content="tooltipContent" tooltip-placement="left">
        <SvgIcon icon="heroicons:language" />
      </ButtonIcon>
    </div>
    <template #dropdown>
      <ElDropdownMenu>
        <ElDropdownItem
          v-for="{ key, label } in langOptions"
          :key="key"
          :value="key"
          :class="{ 'is-active': key === lang }"
          @click="changeLang(key)"
        >
          {{ label }}
        </ElDropdownItem>
      </ElDropdownMenu>
    </template>
  </ElDropdown>
</template>
```

**组件特点**：

- 使用 Element Plus 的 `ElDropdown` 组件实现下拉菜单
- 支持工具提示（tooltip）的多语言显示
- 高亮显示当前选中的语言

---

### 7. 全局头部集成 (`src/layouts/modules/global-header/index.vue`)

```vue
<template>
  <div class="h-full flex-y-center justify-end">
    <!-- 其他组件... -->

    <LangSwitch
      v-if="themeStore.header.multilingual.visible"
      :lang="appStore.locale"
      :lang-options="appStore.localeOptions"
      @change-lang="appStore.changeLocale"
    />

    <!-- 其他组件... -->
  </div>
</template>
```

**集成方式**：

- 从 `appStore` 获取当前语言和语言选项
- 监听 `change-lang` 事件，调用 `appStore.changeLocale` 方法
- 可通过主题配置控制是否显示语言切换按钮

---

### 8. TypeScript 类型定义 (`src/typings/app.d.ts`)

```typescript
declare namespace App {
  namespace I18n {
    type LangType = "en-US" | "zh-CN"; // 支持的语言类型

    type LangOption = {
      label: string; // 语言显示名称
      key: LangType; // 语言代码
    };

    type Schema = {
      system: {
        /* ... */
      };
      common: {
        /* ... */
      };
      route: {
        /* ... */
      };
      page: {
        /* ... */
      };
      // ... 更多模块
    };

    // 翻译函数的类型定义
    type $T = (key: I18nRouteKey | string, ...args: any[]) => string;
  }
}
```

**类型安全优势**：

- 编译时检查语言类型，避免拼写错误
- IDE 自动补全翻译 key
- 确保语言文件结构一致性

---

## 使用指南

### 1. 在组件中使用翻译

#### 1.1 Composition API 方式

```vue
<script setup lang="ts">
import { $t } from "@/locales";

// 简单翻译
const title = $t("common.add");

// 带参数的翻译
const welcomeMsg = $t("page.login.common.welcomeBack", { userName: "John" });
</script>

<template>
  <div>
    <h1>{{ title }}</h1>
    <p>{{ welcomeMsg }}</p>
  </div>
</template>
```

#### 1.2 Options API 方式

```vue
<script lang="ts">
import { defineComponent } from "vue";
import { useI18n } from "vue-i18n";

export default defineComponent({
  setup() {
    const { t } = useI18n();

    return {
      title: t("common.add"),
    };
  },
});
</script>
```

### 2. 在路由中使用 i18n

路由配置中通过 `meta.i18nKey` 指定翻译 key：

```typescript
{
  path: '/product-manage',
  name: 'personal-content_product-manege',
  component: () => import('@/views/personal-content/product-manege/index.vue'),
  meta: {
    i18nKey: 'route.personal-content_product-manege',  // 翻译 key
    title: '产品管理'  // 备用标题（如果没有 i18nKey）
  }
}
```

### 3. 在菜单中使用 i18n

菜单配置中通过 `i18nKey` 指定翻译 key：

```typescript
{
  key: 'personal-content_product-manege',
  label: '产品管理',           // 备用标签
  i18nKey: 'route.personal-content_product-manege',  // 翻译 key
  children: [/* ... */]
}
```

### 4. 手动切换语言

```typescript
import { useAppStore } from "@/store/modules/app";

const appStore = useAppStore();

// 切换到英文
appStore.changeLocale("en-US");

// 切换到中文
appStore.changeLocale("zh-CN");
```

---

## 扩展说明

### 1. 添加新语言

#### 步骤 1：创建语言文件

在 `src/locales/langs/` 目录下创建新文件，如 `ja-jp.ts`：

```typescript
const local: App.I18n.Schema = {
  system: {
    title: "SoybeanAdmin",
    // ... 其他翻译
  },
  // ... 其他模块
};

export default local;
```

#### 步骤 2：更新类型定义

在 `src/typings/app.d.ts` 中更新 `LangType`：

```typescript
type LangType = "en-US" | "zh-CN" | "ja-JP";
```

#### 步骤 3：注册语言资源

在 `src/locales/locale.ts` 中导入并注册：

```typescript
import zhCN from "./langs/zh-cn";
import enUS from "./langs/en-us";
import jaJP from "./langs/ja-jp";

const locales: Record<App.I18n.LangType, App.I18n.Schema> = {
  "zh-CN": zhCN,
  "en-US": enUS,
  "ja-JP": jaJP,
};

export default locales;
```

#### 步骤 4：更新语言选项

在 `src/store/modules/app/index.ts` 中添加语言选项：

```typescript
const localeOptions: App.I18n.LangOption[] = [
  { label: "中文", key: "zh-CN" },
  { label: "English", key: "en-US" },
  { label: "日本語", key: "ja-JP" },
];
```

#### 步骤 5：更新 dayjs 本地化

在 `src/locales/dayjs.ts` 中添加映射：

```typescript
import "dayjs/locale/ja";

export function setDayjsLocale(lang: App.I18n.LangType = "zh-CN") {
  const localMap = {
    "zh-CN": "zh-cn",
    "en-US": "en",
    "ja-JP": "ja",
  } satisfies Record<App.I18n.LangType, string>;

  // ... 其他代码
}
```

#### 步骤 6：更新 Element Plus UI 本地化（可选）

如果 Element Plus 支持该语言，在 `src/locales/ui.ts` 中添加：

```typescript
import ja from "element-plus/dist/locale/ja.mjs";

export const UILocales: any = {
  "zh-CN": zhCn,
  "en-US": en,
  "ja-JP": ja,
};
```

### 2. 语言文件组织结构建议

建议按照功能模块组织语言文件：

```
langs/
├── zh-cn/
│   ├── index.ts          # 聚合所有模块
│   ├── system.ts         # 系统相关
│   ├── common.ts         # 通用文本
│   ├── route.ts          # 路由名称
│   └── page/            # 页面相关
│       ├── login.ts
│       └── product.ts
└── en-us/
    └── ... (相同结构)
```

### 3. 性能优化建议

1. **按需加载语言文件**：对于大型应用，可以考虑按需加载语言文件
2. **缓存翻译结果**：对于频繁使用的翻译，可以缓存结果
3. **懒加载**：使用动态导入减少初始包大小

### 4. 常见问题

#### Q1: 翻译 key 找不到怎么办？

A: vue-i18n 会使用回退语言（fallbackLocale），如果回退语言也找不到，会显示 key 本身。

#### Q2: 如何动态切换 Element Plus 的语言？

A: 需要在 `main.ts` 或组件中动态设置 Element Plus 的 `locale`：

```typescript
import { ElConfigProvider } from 'element-plus';
import { UILocales } from '@/locales/ui';
import { useAppStore } from '@/store/modules/app';

const appStore = useAppStore();

// 在组件中使用
<ElConfigProvider :locale="UILocales[appStore.locale]">
  <router-view />
</ElConfigProvider>
```

#### Q3: 如何获取当前语言？

A: 通过 `appStore.locale` 或 `i18n.global.locale.value` 获取。

---

## 总结

本项目的国际化实现具有以下特点：

1. **类型安全**：完整的 TypeScript 类型定义，编译时检查
2. **响应式更新**：语言切换后自动更新所有相关 UI
3. **持久化存储**：用户选择的语言保存到 localStorage
4. **完整集成**：与路由、菜单、标签页、日期库等深度集成
5. **易于扩展**：清晰的代码结构，便于添加新语言

通过以上机制，项目实现了完整的国际化语言切换功能，为用户提供了良好的多语言体验。

# 豆包回答版

你希望了解在Vue3项目中实现中英文语言切换的核心逻辑，我会以Vue官方推荐的国际化库 `vue-i18n@9+` 为例，拆解核心思路并给出可直接运行的代码示例。

### 一、核心实现思路

Vue3中实现语言切换的核心逻辑围绕「语言包管理」+「i18n实例控制」展开，关键步骤如下：

1. 定义中英文语言包（将所有需要翻译的文案按模块分类维护）；
2. 配置`vue-i18n`实例，指定默认语言、挂载语言包，并实现语言持久化（避免刷新后还原）；
3. 在组件中通过API调用翻译文案；
4. 实现语言切换方法：修改i18n实例的`locale`属性，并同步更新本地存储。

### 二、完整代码示例

#### 1. 安装依赖

首先安装适配Vue3的`vue-i18n`版本：

```bash
# npm
npm install vue-i18n@9.x --save

# yarn
yarn add vue-i18n@9.x
```

#### 2. 定义语言包

在`src/locales`目录下创建语言包文件（按模块分类更易维护）：

**① 英文语言包：src/locales/en.ts**

```typescript
export default {
  // 通用模块
  common: {
    title: "Vue3 Language Switch Demo",
    switchLang: "Switch Language",
    welcome: "Welcome to use Vue3 i18n",
  },
  // 按钮模块
  button: {
    confirm: "Confirm",
    cancel: "Cancel",
  },
  // 提示模块
  tip: {
    success: "Operation succeeded!",
    fail: "Operation failed!",
  },
};
```

**② 中文语言包：src/locales/zh.ts**

```typescript
export default {
  common: {
    title: "Vue3语言切换示例",
    switchLang: "切换语言",
    welcome: "欢迎使用Vue3国际化功能",
  },
  button: {
    confirm: "确认",
    cancel: "取消",
  },
  tip: {
    success: "操作成功！",
    fail: "操作失败！",
  },
};
```

#### 3. 配置i18n实例

创建`src/locales/index.ts`，封装i18n实例并实现语言持久化：

```typescript
import { createI18n } from "vue-i18n";
// 导入语言包
import zh from "./zh";
import en from "./en";

// 从本地存储获取语言，默认中文
const getLocale = () => {
  const lang = localStorage.getItem("vue3-lang");
  // 验证本地存储的语言是否有效，无效则返回中文
  if (["zh", "en"].includes(lang || "")) {
    return lang;
  }
  // 也可根据浏览器默认语言判断
  const browserLang = navigator.language.toLowerCase();
  return browserLang.includes("en") ? "en" : "zh";
};

// 语言包集合
const messages = {
  zh,
  en,
};

// 创建i18n实例
const i18n = createI18n({
  // 组合式API模式（Vue3推荐）
  legacy: false,
  // 全局注入$t方法（模板中可直接使用）
  globalInjection: true,
  // 当前语言
  locale: getLocale(),
  // 备用语言
  fallbackLocale: "zh",
  // 语言包
  messages,
});

export default i18n;
```

#### 4. 挂载i18n到Vue应用

修改`src/main.ts`，将i18n实例挂载到app：

```typescript
import { createApp } from "vue";
import App from "./App.vue";
// 导入i18n实例
import i18n from "./locales";

const app = createApp(App);
// 挂载i18n
app.use(i18n);
app.mount("#app");
```

#### 5. 组件中使用&切换语言

在`src/App.vue`中实现文案展示和语言切换功能：

```vue
<template>
  <div class="app">
    <h1>{{ $t("common.title") }}</h1>
    <p>{{ $t("common.welcome") }}</p>
    <!-- 语言切换按钮 -->
    <button @click="switchLang('zh')">中文</button>
    <button @click="switchLang('en')">English</button>
    <!-- 其他文案示例 -->
    <div class="btn-group">
      <button>{{ $t("button.confirm") }}</button>
      <button>{{ $t("button.cancel") }}</button>
    </div>
    <p>{{ $t("tip.success") }}</p>
  </div>
</template>

<script setup lang="ts">
import { useI18n } from "vue-i18n";

// 获取i18n实例（组合式API）
const { locale } = useI18n();

// 语言切换核心方法
const switchLang = (lang: "zh" | "en") => {
  // 修改当前语言（实时生效）
  locale.value = lang;
  // 持久化到本地存储，避免刷新后还原
  localStorage.setItem("vue3-lang", lang);
};
</script>

<style scoped>
.app {
  padding: 20px;
}
.btn-group {
  margin: 10px 0;
}
button {
  margin-right: 10px;
  padding: 5px 10px;
}
</style>
```

### 三、关键逻辑解释

1. **语言持久化**：通过`localStorage`存储当前语言，页面初始化时从本地读取，解决刷新后语言还原的问题；
2. **核心API**：
   - `createI18n`：创建i18n实例，`legacy: false`开启Vue3组合式API模式；
   - `useI18n()`：在组合式API组件中获取i18n实例，`locale.value`是响应式的，修改后页面文案会实时更新；
   - `$t('key')`：模板中直接调用翻译方法，`key`对应语言包中的层级路径（如`common.title`）；
3. **语言包设计**：按模块（common/button/tip）分类维护文案，便于大型项目管理。

### 总结

1. Vue3语言切换的核心是基于`vue-i18n`管理语言包，并通过修改`locale`属性实现实时切换；
2. 语言持久化需结合`localStorage`，避免刷新后语言还原；
3. 组件中可通过`useI18n()`（组合式API）或`$t()`（模板）调用翻译文案，切换逻辑只需修改`locale`并同步本地存储。

这个方案是Vue3国际化的标准实践，支持大型项目扩展（如新增更多语言、按页面拆分语言包等）。
